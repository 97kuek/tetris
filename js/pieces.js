// テトリミノの形状・色・生成ロジックを定義する

// 各テトリミノの形状を2次元配列で定義
// 配列内の0でない数字はブロックが存在することを示し、その数字は色IDに対応する
const PIECES_DEF = {
    'I': [[0, 1, 0, 0], [0, 1, 0, 0], [0, 1, 0, 0], [0, 1, 0, 0]],
    'J': [[2, 0, 0], [2, 2, 2], [0, 0, 0]],
    'L': [[0, 0, 3], [3, 3, 3], [0, 0, 0]],
    'O': [[4, 4], [4, 4]],
    'S': [[0, 5, 5], [5, 5, 0], [0, 0, 0]],
    'T': [[0, 6, 0], [6, 6, 6], [0, 0, 0]],
    'Z': [[7, 7, 0], [0, 7, 7], [0, 0, 0]]
};

// ミノの種類（'I', 'J'など）と色ID（`constants.js`の`COLORS`配列のインデックス）をマッピングします。
const TYPE_TO_COLOR = { 'I': 1, 'J': 2, 'L': 3, 'O': 4, 'S': 5, 'T': 6, 'Z': 7 };

/**
 * テトリミノを生成するためのクラスです。
 * このクラスは「7-bag」と呼ばれるアルゴリズムを実装しています。
 * 7-bagとは、7種類のミノを1セット（袋）とし、袋が空になるまでミノをランダムに取り出す方式です。
 * これにより、同じミノが連続して出現したり、特定のミノが長期間出現しないといった偏りを防ぎ、
 * 公平なゲームプレイを提供します。
 */
class PieceGenerator {
    constructor() {
        // ミノを格納する「袋」
        this.bag = [];
    }

    /**
     * 袋（bag）が空になったときに、7種類のミノで袋を補充します。
     * @private
     */
    _refill() {
        // 7種類のミノの型
        const types = 'ILJOTSZ'.split('');

        // Fisher-Yatesアルゴリズムを使って、配列をシャッフル（ランダムに並び替え）します。
        for (let i = types.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [types[i], types[j]] = [types[j], types[i]];
        }
        // シャッフルされたミノの配列を袋にセットします。
        this.bag = types;
    }

    /**
     * 次のミノを袋から取り出して返す
     * @returns {object} - 新しいミノオブジェクト。形状、色ID、種類、初期座標が含まれる
     */
    next() {
        // 袋が空なら、新しいミノで補充する
        if (this.bag.length === 0) {
            this._refill();
        }
        // 袋の最後からミノの種類を取り出します (pop)。
        const type = this.bag.pop();

        // 取り出した種類に対応するミノの情報を元に、新しいミノオブジェクトを生成して返します。
        // `PIECES_DEF[type].map(row => [...row])` は、元の形状定義を変更しないように
        // 配列をディープコピー（値渡しのコピー）しています。
        return {
            matrix: PIECES_DEF[type].map(row => [...row]),
            colorId: TYPE_TO_COLOR[type],
            type: type,
            x: 0, // 初期X座標（スポーン時に中央に配置される）
            y: 0  // 初期Y座標
        };
    }
}
